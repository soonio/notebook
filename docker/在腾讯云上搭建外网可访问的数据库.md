#  在腾讯云上搭建外网可访问的MariaDB数据库

## 1 安装DOCKER



> 参考docker官网文档即可

## 2 开放腾讯云服务器端口

2.1 新增安全组

开放 TCP:3308端口

2.2 安全组关联对应的服务器即可


## 3 拉取镜像
### 3.1 MariaDB
```bash
docker pull mariadb
```

### 3.2 mysql
```bash
docker pull mysql:5.7.20
```
> 版本自选


## 4 启动docker中的数据库

### 4.1 MariaDB
```bash
docker run \
    -v /data/mariadb/:/var/lib/mysql \
    -p 3308:3306 \
    -e MYSQL_ROOT_PASSWORD=123456 \
    --privileged=true \
    --restart unless-stopped \
    --name mariadbs \
    -d mariadb:latest
```
> 我绑定的端口是 3308  
> 对应的数据库文件存在宿主机的 **/data/mariadb/**

### 4.2 MySQL 
```bash
docker run \
    -v /data/db/mysql/data:/var/lib/mysql \
    -v /data/db/mysql/backup:/data \
    -v /data/db/mysql/conf.d:/etc/mysql/conf.d \
    -p 3306:3306 \
    -e MYSQL_ROOT_PASSWORD=123456 \
    --privileged=true \
    --restart unless-stopped \
    --name mysql \
    -d mysql:8.0.16
```
> mysql如果指定版本或者lasted的话，会导致wine中的navicat客户端无法链接的问题，暂不知道原因

> 备份文件恢复，可以通过复制文件到宿主机/data/mysql中，然后在容器中使用 mysql -u root -p dbname < /var/lib/mysql/demo.sql进行快速恢复

> 查看容器中mysql读取配置的顺序 `mysqld --verbose --help | grep -A 1 'Default options'`

修改mysql8的配置，直接PHP的简单链接方式
/data/db/mysql/conf.d/docker.cnf 
```ini
[mysqld]
skip-host-cache
skip-name-resolve

default_authentication_plugin=mysql_native_password
```


## 5 docker拉取镜像问题
```
docker pull mariadb
# 出现以下错误
Error response from daemon: Get https://registry-1.docker.io/v2/: net/http: TLS handshake timeout
```

### 5.1 稍后重试即可

### 5.2修改镜像源
/etc/sysconfig/docker
```config
OPTIONS='--selinux-enabled --log-driver=journald --registry-mirror=http://hub-mirror.c.163.com'
```
> 上面使用了网易云的镜像 http://hub-mirror.c.163.com  其他的自行百度

## 6 mysql创建后新建用户问题
```
// 创建用户
CREATE USER 'developer'@'%' IDENTIFIED BY '123456';

// 删除用户
DROP USER developer @'%';

// 给用户授权所有权限
GRANT ALL PRIVILEGES ON dbname.* TO 'developer' @'%' WITH GRANT OPTION;
// 授权部分权限
GRANT SELECT,
	INSERT, UPDATE,
	DELETE,
	DROP,
	CREATE,
	INDEX,
	ALTER,
	REFERENCES,
	CREATE TEMPORARY TABLES,
	LOCK TABLES,
	EXECUTE ON `converyor-test`.* TO 'developer' @'%' WITH GRANT OPTION;

// 撤销用户的授权
REVOKE ALL PRIVILEGES ON *.* FROM 'developer' @'%';

// 查看授权结果
SHOW GRANTS FOR 'developer' @'%';

// 刷新权限
flush privileges;
```
